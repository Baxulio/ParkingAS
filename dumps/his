DELIMITER $$
CREATE DEFINER=`root`@`%` PROCEDURE `MoveToHistory`(IN `b_rf_id` INT, IN `b_out_number` TINYINT)
    MODIFIES SQL DATA
BEGIN

DECLARE b_id INT;
DECLARE b_in_time DATETIME;
DECLARE b_in_number TINYINT;
DECLARE b_img TINYTEXT;

DECLARE b_price DOUBLE;

DECLARE b_last_insert_id INT;

SELECT  `id`, `in_time`, `in_number`, `img` 
FROM `Parking`.`Active` 
WHERE b_rf_id=`rf_id` LIMIT 1
INTO b_id, b_in_time, b_in_number, b_img;

SELECT `price_per_hour` 
FROM `Parking`.`Price` 
INTO b_price;

INSERT INTO `Parking`.`History` (`rf_id`, `in_time`, `out_time`, `in_number`, `out_number`, `price`, `img`) 
VALUES (b_rf_id, b_in_time, SYSDATE(), b_in_number, b_out_number, TIMESTAMPDIFF(MINUTE,b_in_time,SYSDATE())*b_price/60, b_img);

SET b_last_insert_id = LAST_INSERT_ID();

DELETE FROM `Parking`.`Active` 
WHERE  `id`=b_id;

SELECT `in_time`, `out_time`, `in_number`, `price` 
FROM `Parking`.`History` 
WHERE `id` = b_last_insert_id;

END$$
DELIMITER ;
 
